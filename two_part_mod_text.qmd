---
title: "explaining hierarchical 2 part model"
format: html
editor: visual
---

## Set-Up

Load in the packages and data first

```{r}
library(rstanarm)
library(tidyverse)
library(here)

dat_raw <- read_rds(here("data", "wa_plots_public.rds"))
```


Do some data processing

```{r}
dat <- dat_raw %>% 
  # select our predictor, response, and group variables
  select(tcc, DRYBIO_AG_TPA_live_ADJ, COUNTYCD) %>% 
  # reindex the group variable to be sequantial 1...(# of county codes)
  group_by(COUNTYCD) %>% 
  mutate(group_id = cur_group_id()) %>% 
  ungroup() %>% 
  # create response variable for logistic regression model
  mutate(DRYBIO_AG_INDICATOR = ifelse(DRYBIO_AG_TPA_live_ADJ > 0, 1, 0))
```


## The Two Part Model

Let $y$ represent the response variable and $X$ and $U$ represent the covariates and random effects respectively. In the setting where our response variable is substantially zero we can use the law of total expectation and condition on whether that response variable is zero or nonzero

$$
\begin{aligned}
E[y \ | \ X, \ U] &=  E[y \ | X, \ U, \  y = 0]P(y = 0 \ | \ X, \ U)  \\
& \ \ \ \ \ + E[y \ | X, \ U, \ y > 0]P(y>0 \ | X, \ U) \\
&= 0 \cdot P(y = 0 \ | \ X, \ U) + E[y \ | X, \ U, \ y > 0]P(y>0 \ | X, \ U) \\
&= E[y \ | X, \ U, \ y > 0]P(y>0 \ | X, \ U)
\end{aligned}
$$

This provides motivation for modeling this type of data using a two-part model. A linear one built on the nonzero portion of our response, and a logistic regression model predicting whether our response variable is nonzero.

Because of the grouped structure of the data it makes sense to fit each of these using a hierarchical model with varying slopes.

We now walk through how to do this in a bayesian frame:

## Model Layers for model 1

#### Variability within a county j

$y_{ij}\ | \ u_j , \beta, \sigma_y \sim \mathcal{N}(\mu_{ij}, \sigma_y^2)$ where $\mu_{ij} = u_j + \beta X_{ij}$

Here we have
- $u_j$ represents the intercept of the regression model for county $j$
- $\beta$ the global slope coefficient
- $\sigma_y$ within county variability parameter

That all need to be estimated

#### Variability between counties j

$u_j \ | \ \beta_0, \sigma_u \sim \mathcal{N}(\beta_0, \sigma_u^2)$ 

Here we have
- $\beta_0$ represents the global average intercept across all counties
- $\sigma_u$ represents the between group variability in intercepts $u_j$

#### Global Priors

We set proper priors on $\beta_0, \beta, \sigma_u, \sigma_y$ as the final level in the model.

## Building Model 1

```{r}
dat_y_mod <- dat %>% 
  filter(DRYBIO_AG_TPA_live_ADJ > 0)
```

We can use the data to choose our priors

Our global slope $\beta$ which could be set as 

```{r}
dat_y_mod %>% 
  ggplot(aes(x = tcc, y = DRYBIO_AG_TPA_live_ADJ, group = as.factor(group_id))) +
  geom_smooth(method = "lm", se = F)
```


```{r}
mod_y <- stan_glmer(
  DRYBIO_AG_TPA_live_ADJ ~ tcc + (1 | group_id), 
  data = dat_y_mod, family = gaussian,
  prior_intercept = normal(100, 10),
  prior = normal(2.5, 1), 
  prior_aux = exponential(1, autoscale = TRUE),
  prior_covariance = decov(reg = 1, conc = 1, shape = 1, scale = 1),
  chains = 4, iter = 5000*2, seed = 84735
)
```

